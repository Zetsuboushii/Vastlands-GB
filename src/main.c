#define __TARGET_gb

#include <axe.h>
#include <bkg.h>
#include <gb/cgb.h>
#include <gb/gb.h>
#include <gb/hardware.h>
#include <gb/metasprites.h>
#include <gbc_hicolor.h>
#include <gbdk/console.h>
#include <gbdk/emu_debug.h>
#include <gbdk/font.h>
#include <gbdk/platform.h>
#include <palettes.h>
#include <player_attack.h>
#include <player_down.h>
#include <player_left.h>
#include <player_up.h>
#include <stdbool.h>
#include <stdint.h>
#include <stdio.h>
#include <titlescreen.h>

// --- Hier kommen unsere eigenen Includes:
#include "camera.h"
#include "player.h"
#include "titlescreen.h"

// --- Definitions ---
#define LAST_TILE_INDEX 255u
#define TILEMAP_WIDTH (bkg_WIDTH >> 3)
#define TILEMAP_HEIGHT (bkg_HEIGHT >> 3)

#define TILE_SIZE 16
#define WALKING_SPEED 3
#define ARRAY_COUNT(arr) (sizeof(arr) / sizeof(arr[0]))

#define MIN(A, B) ((A) < (B) ? (A) : (B))
#define UPDATE_KEYS() (key_state_prev = key_state, key_state = joypad())
#define KEY_NEW_PRESS(mask) ((key_state & ~key_state_prev) & (mask))
#define KEY_IS_PRESSED(mask) (key_state & (mask))

// Valid tiles for collision detection
#define NUM_VALID_TILES 21
const uint8_t valid_tiles[NUM_VALID_TILES] = {
    0x04, 0x05, 0x06, 0x0c, 0x0d, 0x2e, 0x33, 0x34, 0x79, 0x2d, 0xa3,
    0x38, 0x97, 0x98, 0x6e, 0xa4, 0x6f, 0x60, 0x53, 0x54, 0x61
};

// Inputs
uint8_t key_state, key_state_prev;
uint8_t joypad_current = 0;

// Sprite Two-Frame Counter
uint8_t two_frame_counter, two_frame_real_value = 0;

void update_two_frame_counter() {
    two_frame_counter += 3;
    two_frame_real_value = two_frame_counter >> 4;
    if (two_frame_real_value >= 2) {
        two_frame_real_value = 0;
        two_frame_counter = 0;
    }
}

/* ----------------------------------------------------------------------------
   KOLLISIONSFUNKTION
   ----------------------------------------------------------------------------*/
bool is_valid_tile(uint16_t x, uint16_t y) {
    uint16_t tile_x = x / 8;
    uint16_t tile_y = y / 8;
    if (tile_x > TILEMAP_WIDTH || tile_x < 1 || tile_y > TILEMAP_HEIGHT || tile_y < 1) {
        return false;
    }

    uint16_t index = (tile_y - 1) * TILEMAP_WIDTH + (tile_x - 1);
    uint16_t tile_dr;
    SWITCH_ROM_MBC5(2); // bkg_map in Bank 2
    tile_dr = bkg_map[index];
    SWITCH_ROM_MBC5(0);

    EMU_printf("Checking: Tile %x in %u,%u at %x\n", tile_dr, tile_y - 1, tile_x - 1, index);
    for (uint8_t i = 0; i < ARRAY_COUNT(valid_tiles); i++) {
        if (tile_dr == valid_tiles[i]) {
            return true;
        }
    }
    return false;
}

/* ----------------------------------------------------------------------------
   TILE VOR DEM SPIELER AUSLESEN
   ----------------------------------------------------------------------------*/
uint8_t get_tile_in_front_of_player(void) {
    // Aktuelle Pixel-Koordinaten
    int16_t front_x = (int16_t)player_x;
    int16_t front_y = (int16_t)player_y;

    // Je nach Richtung 8 Pixel nach vorne (mittelgroßer Abstand)
    switch (player_direction) {
    case J_UP: front_y -= 8;
        break;
    case J_DOWN: front_y += 8;
        break;
    case J_LEFT: front_x -= 8;
        break;
    case J_RIGHT: front_x += 8;
        break;
    }

    // Umrechnen in Tile-Koordinaten
    uint16_t tile_x = (uint16_t)(front_x >> 3);
    uint16_t tile_y = (uint16_t)(front_y >> 3);

    if (tile_x < 1 || tile_x > TILEMAP_WIDTH || tile_y < 1 || tile_y > TILEMAP_HEIGHT) {
        return 0xFF; // ungültige Position
    }

    // Index in bkg_map
    uint16_t index = (tile_y - 1) * TILEMAP_WIDTH + (tile_x - 1);

    SWITCH_ROM_MBC5(2);
    uint8_t tile_id = bkg_map[index];
    SWITCH_ROM_MBC5(0);

    return tile_id;
}

/* ============================================================================
   DIALOGMECHANIK
   ============================================================================
   - Zweizeiliges Fenster, das beim Drücken von (A) um 2 Zeilen weiterscrollt.
   - (B) schließt das Fenster sofort.
   ============================================================================
*/

// Offsets, etc.
#define DIALOG_FIRST_ROW_START 0xD0
#define DIALOG_SECOND_ROW_START 0xE0
#define TILE_BLACK   0xF0
#define TILE_ARROW   0xF1
#define CHAR_OFFSET  32   // ' ' = ASCII 32 -> index 0 in char_sprites

// Jede Zeile: 16 Zeichen + \0
#define DIALOG_MAX_STRING_SIZE 17

// Schwarze Tile
const unsigned char black_tile[16] =
{
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF
};

// Pfeil-Tile
const unsigned char arrow_tile[16] =
{
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x83, 0x83,
    0xC7, 0xC7, 0xEF, 0xEF, 0xFF, 0xFF, 0xFF, 0xFF
};

// Font: 96 Zeichen
const uint8_t char_sprites[96][16] = {
    // 0 - 31
    {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
    {0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF, 0xE7, 0xE7, 0xFF, 0xFF},
    {0x99, 0x99, 0x99, 0x99, 0xBB, 0xBB, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
    {0xFF, 0xFF, 0xDB, 0xDB, 0x81, 0x81, 0xDB, 0xDB, 0xDB, 0xDB, 0x81, 0x81, 0xDB, 0xDB, 0xFF, 0xFF},
    {0xEB, 0xEB, 0xC1, 0xC1, 0xAA, 0xAA, 0xC3, 0xC3, 0xE1, 0xE1, 0xAA, 0xAA, 0xC1, 0xC1, 0xEB, 0xEB},
    {0x9D, 0x9D, 0x99, 0x99, 0xF3, 0xF3, 0xE7, 0xE7, 0xCF, 0xCF, 0x99, 0x99, 0xB9, 0xB9, 0xFF, 0xFF},
    {0x87, 0x87, 0x33, 0x33, 0x9E, 0x9E, 0x31, 0x31, 0x33, 0x33, 0x33, 0x33, 0x87, 0x87, 0xFF, 0xFF},
    {0xE7, 0xE7, 0xE7, 0xE7, 0xEF, 0xEF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
    {0xF7, 0xF7, 0xEF, 0xEF, 0xCF, 0xCF, 0xCF, 0xCF, 0xCF, 0xCF, 0xCF, 0xCF, 0xEF, 0xEF, 0xF7, 0xF7},
    {0xDF, 0xDF, 0xEF, 0xEF, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xEF, 0xEF, 0xDF, 0xDF},
    {0xFF, 0xFF, 0xAB, 0xAB, 0xC7, 0xC7, 0x01, 0x01, 0xC7, 0xC7, 0xAB, 0xAB, 0xFF, 0xFF, 0xFF, 0xFF},
    {0xFF, 0xFF, 0xE7, 0xE7, 0xE7, 0xE7, 0x81, 0x81, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF, 0xFF, 0xFF},
    {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xCF, 0xCF, 0xCF, 0xCF, 0xDF, 0xDF},
    {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
    {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF},
    {0xFD, 0xFD, 0xF9, 0xF9, 0xF3, 0xF3, 0xE7, 0xE7, 0xCF, 0xCF, 0x9F, 0x9F, 0x3F, 0x3F, 0xFF, 0xFF},
    {0xC3, 0xC3, 0x99, 0x99, 0x91, 0x91, 0x89, 0x89, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xC3, 0xFF, 0xFF},
    {0xE7, 0xE7, 0xC7, 0xC7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF},
    {0xC3, 0xC3, 0x99, 0x99, 0xF1, 0xF1, 0xE3, 0xE3, 0xC7, 0xC7, 0x8F, 0x8F, 0x81, 0x81, 0xFF, 0xFF},
    {0x81, 0x81, 0xF3, 0xF3, 0xE7, 0xE7, 0xC3, 0xC3, 0xF9, 0xF9, 0xB9, 0xB9, 0xC3, 0xC3, 0xFF, 0xFF},
    {0xF3, 0xF3, 0xE3, 0xE3, 0xD3, 0xD3, 0xB3, 0xB3, 0x81, 0x81, 0xF3, 0xF3, 0xF3, 0xF3, 0xFF, 0xFF},
    {0x81, 0x81, 0x9F, 0x9F, 0x83, 0x83, 0xF9, 0xF9, 0xF9, 0xF9, 0xB9, 0xB9, 0xC3, 0xC3, 0xFF, 0xFF},
    {0xE3, 0xE3, 0xDF, 0xDF, 0x9F, 0x9F, 0x83, 0x83, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xC3, 0xFF, 0xFF},
    {0x81, 0x81, 0xF9, 0xF9, 0xF1, 0xF1, 0xE3, 0xE3, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF},
    {0xC3, 0xC3, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xC3, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xC3, 0xFF, 0xFF},
    {0xC3, 0xC3, 0x99, 0x99, 0x99, 0x99, 0xC1, 0xC1, 0xF9, 0xF9, 0xF3, 0xF3, 0xC7, 0xC7, 0xFF, 0xFF},
    {0xFF, 0xFF, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF, 0xFF, 0xFF, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF},
    {0xFF, 0xFF, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF, 0xE7, 0xE7, 0xE7, 0xE7, 0xEF, 0xEF, 0xFF, 0xFF},
    {0xF9, 0xF9, 0xF3, 0xF3, 0xE7, 0xE7, 0xCF, 0xCF, 0xE7, 0xE7, 0xF3, 0xF3, 0xF9, 0xF9, 0xFF, 0xFF},
    {0xFF, 0xFF, 0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, 0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, 0xFF, 0xFF},
    {0x9F, 0x9F, 0xCF, 0xCF, 0xE7, 0xE7, 0xF3, 0xF3, 0xE7, 0xE7, 0xCF, 0xCF, 0x9F, 0x9F, 0xFF, 0xFF},
    {0xC3, 0xC3, 0xB9, 0xB9, 0xF9, 0xF9, 0xF3, 0xF3, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF, 0xE7, 0xE7},
    // 32 - 63
    {0xC3, 0xC3, 0x99, 0x99, 0x91, 0x91, 0x95, 0x95, 0x91, 0x91, 0x9F, 0x9F, 0xC3, 0xC3, 0xFF, 0xFF},
    {0xC3, 0xC3, 0x99, 0x99, 0x99, 0x99, 0x81, 0x81, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xFF, 0xFF},
    {0x83, 0x83, 0x99, 0x99, 0x99, 0x99, 0x83, 0x83, 0x99, 0x99, 0x99, 0x99, 0x83, 0x83, 0xFF, 0xFF},
    {0xC3, 0xC3, 0x9D, 0x9D, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9D, 0x9D, 0xC3, 0xC3, 0xFF, 0xFF},
    {0x83, 0x83, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x83, 0x83, 0xFF, 0xFF},
    {0x81, 0x81, 0x9F, 0x9F, 0x9F, 0x9F, 0x83, 0x83, 0x9F, 0x9F, 0x9F, 0x9F, 0x81, 0x81, 0xFF, 0xFF},
    {0x81, 0x81, 0x9F, 0x9F, 0x9F, 0x9F, 0x83, 0x83, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0xFF, 0xFF},
    {0xC3, 0xC3, 0x9D, 0x9D, 0x9F, 0x9F, 0x91, 0x91, 0x99, 0x99, 0x99, 0x99, 0xC1, 0xC1, 0xFF, 0xFF},
    {0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x81, 0x81, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xFF, 0xFF},
    {0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF},
    {0xF9, 0xF9, 0xF9, 0xF9, 0xF9, 0xF9, 0xF9, 0xF9, 0xF9, 0xF9, 0xB9, 0xB9, 0xC3, 0xC3, 0xFF, 0xFF},
    {0x99, 0x99, 0x93, 0x93, 0x87, 0x87, 0x8F, 0x8F, 0x87, 0x87, 0x93, 0x93, 0x99, 0x99, 0xFF, 0xFF},
    {0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x83, 0x83, 0xFF, 0xFF},
    {0x03, 0x03, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x39, 0x39, 0x39, 0x39, 0xFF, 0xFF},
    {0x9D, 0x9D, 0x8D, 0x8D, 0x85, 0x85, 0xA1, 0xA1, 0xB1, 0xB1, 0xB9, 0xB9, 0xBD, 0xBD, 0xFF, 0xFF},
    {0xC3, 0xC3, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xC3, 0xFF, 0xFF},
    {0x83, 0x83, 0x99, 0x99, 0x99, 0x99, 0x83, 0x83, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0xFF, 0xFF},
    {0xC3, 0xC3, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xC3, 0xF9, 0xF9},
    {0x83, 0x83, 0x99, 0x99, 0x99, 0x99, 0x83, 0x83, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xFF, 0xFF},
    {0xC3, 0xC3, 0x9D, 0x9D, 0x8F, 0x8F, 0xC3, 0xC3, 0xF1, 0xF1, 0xB9, 0xB9, 0xC3, 0xC3, 0xFF, 0xFF},
    {0x81, 0x81, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF},
    {0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xC3, 0xFF, 0xFF},
    {0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x9B, 0x9B, 0x87, 0x87, 0xFF, 0xFF},
    {0x39, 0x39, 0x39, 0x39, 0x39, 0x39, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x03, 0x03, 0xFF, 0xFF},
    {0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xC3, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xFF, 0xFF},
    {0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xC3, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF},
    {0x81, 0x81, 0xF1, 0xF1, 0xE3, 0xE3, 0xC7, 0xC7, 0x8F, 0x8F, 0x9F, 0x9F, 0x81, 0x81, 0xFF, 0xFF},
    {0xE1, 0xE1, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE1, 0xE1, 0xFF, 0xFF},
    {0xBF, 0xBF, 0x9F, 0x9F, 0xCF, 0xCF, 0xE7, 0xE7, 0xF3, 0xF3, 0xF9, 0xF9, 0xFD, 0xFD, 0xFF, 0xFF},
    {0x87, 0x87, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0x87, 0x87, 0xFF, 0xFF},
    {0xEF, 0xEF, 0xC7, 0xC7, 0x93, 0x93, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
    {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x81, 0x81, 0xFF, 0xFF},
    // 64 - 95
    {0xFF, 0xFF, 0x3F, 0x3F, 0x3F, 0x3F, 0x9F, 0x9F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
    {0xFF, 0xFF, 0xC3, 0xC3, 0xB9, 0xB9, 0xC1, 0xC1, 0x99, 0x99, 0x99, 0x99, 0xC1, 0xC1, 0xFF, 0xFF},
    {0x9F, 0x9F, 0x83, 0x83, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x83, 0x83, 0xFF, 0xFF},
    {0xFF, 0xFF, 0xC3, 0xC3, 0x9D, 0x9D, 0x9F, 0x9F, 0x9F, 0x9F, 0x9D, 0x9D, 0xC3, 0xC3, 0xFF, 0xFF},
    {0xF9, 0xF9, 0xC1, 0xC1, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xC1, 0xC1, 0xFF, 0xFF},
    {0xFF, 0xFF, 0xC3, 0xC3, 0x99, 0x99, 0x81, 0x81, 0x9F, 0x9F, 0x9D, 0x9D, 0xC3, 0xC3, 0xFF, 0xFF},
    {0xE1, 0xE1, 0xCF, 0xCF, 0x83, 0x83, 0xCF, 0xCF, 0xCF, 0xCF, 0xCF, 0xCF, 0xCF, 0xCF, 0xFF, 0xFF},
    {0xFF, 0xFF, 0xC1, 0xC1, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xC1, 0xC1, 0xB9, 0xB9, 0xC3, 0xC3},
    {0x9F, 0x9F, 0x83, 0x83, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xFF, 0xFF},
    {0xE7, 0xE7, 0xFF, 0xFF, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF},
    {0xFF, 0xFF, 0xF7, 0xF7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xA7, 0xA7, 0xCF, 0xCF},
    {0x9F, 0x9F, 0x9B, 0x9B, 0x97, 0x97, 0x8F, 0x8F, 0x87, 0x87, 0x93, 0x93, 0x99, 0x99, 0xFF, 0xFF},
    {0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xF3, 0xF3, 0xFF, 0xFF},
    {0xFF, 0xFF, 0x03, 0x03, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x39, 0x39, 0xFF, 0xFF},
    {0xFF, 0xFF, 0x83, 0x83, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xFF, 0xFF},
    {0xFF, 0xFF, 0xC3, 0xC3, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xC3, 0xFF, 0xFF},
    {0xFF, 0xFF, 0x83, 0x83, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x83, 0x83, 0x9F, 0x9F, 0x9F, 0x9F},
    {0xFF, 0xFF, 0xC1, 0xC1, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xC1, 0xC1, 0xF9, 0xF9},
    {0xFF, 0xFF, 0x93, 0x93, 0x8F, 0x8F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0xFF, 0xFF},
    {0xFF, 0xFF, 0xC3, 0xC3, 0x8D, 0x8D, 0xC7, 0xC7, 0xE3, 0xE3, 0xB1, 0xB1, 0xC3, 0xC3, 0xFF, 0xFF},
    {0xE7, 0xE7, 0xC3, 0xC3, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xF3, 0xF3, 0xFF, 0xFF},
    {0xFF, 0xFF, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xC1, 0xC1, 0xFF, 0xFF},
    {0xFF, 0xFF, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x9B, 0x9B, 0x87, 0x87, 0xFF, 0xFF},
    {0xFF, 0xFF, 0x39, 0x39, 0x39, 0x39, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x03, 0x03, 0xFF, 0xFF},
    {0xFF, 0xFF, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xC3, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xFF, 0xFF},
    {0xFF, 0xFF, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xD9, 0xD9, 0xE1, 0xE1, 0xB9, 0xB9, 0xC3, 0xC3},
    {0xFF, 0xFF, 0x81, 0x81, 0xF1, 0xF1, 0xE3, 0xE3, 0xC7, 0xC7, 0x8F, 0x8F, 0x81, 0x81, 0xFF, 0xFF},
    {0xF1, 0xF1, 0xE7, 0xE7, 0xE7, 0xE7, 0xCF, 0xCF, 0xE7, 0xE7, 0xE7, 0xE7, 0xF1, 0xF1, 0xFF, 0xFF},
    {0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7},
    {0x8F, 0x8F, 0xE7, 0xE7, 0xE7, 0xE7, 0xF3, 0xF3, 0xE7, 0xE7, 0xE7, 0xE7, 0x8F, 0x8F, 0xFF, 0xFF},
    {0xFF, 0xFF, 0x9F, 0x9F, 0x0D, 0x0D, 0x61, 0x61, 0xF3, 0xF3, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
    {0xEF, 0xEF, 0xEF, 0xEF, 0xD7, 0xD7, 0xD7, 0xD7, 0xBB, 0xBB, 0xBB, 0xBB, 0x7D, 0x7D, 0x01, 0x01},
};

// Beispieltext
const unsigned char pangram_a[][DIALOG_MAX_STRING_SIZE] = {
    "Es scheint      ",
    "niemand zu      ",
    "Hause zu        ",
    "sein...         "
};

// Dialog-Flags und Variablen
UBYTE dialog_window_visible = 0;
uint8_t current_line_index = 0;
UBYTE key_down = 0;

// Window-Tilemap (18x5)
const unsigned char dia_wnd_tilemap[] = {
    // Zeile 0 (oben)
    TILE_BLACK, TILE_BLACK, TILE_BLACK, TILE_BLACK, TILE_BLACK,
    TILE_BLACK, TILE_BLACK, TILE_BLACK, TILE_BLACK, TILE_BLACK,
    TILE_BLACK, TILE_BLACK, TILE_BLACK, TILE_BLACK, TILE_BLACK,
    TILE_BLACK, TILE_BLACK, TILE_BLACK,

    // Zeile 1 (Textzeile)
    TILE_BLACK, 0xD0, 0xD1, 0xD2, 0xD3, 0xD4, 0xD5, 0xD6, 0xD7,
    0xD8, 0xD9, 0xDA, 0xDB, 0xDC, 0xDD, 0xDE, 0xDF,
    TILE_BLACK,

    // Zeile 2 (Textzeile)
    TILE_BLACK, 0xE0, 0xE1, 0xE2, 0xE3, 0xE4, 0xE5, 0xE6, 0xE7,
    0xE8, 0xE9, 0xEA, 0xEB, 0xEC, 0xED, 0xEE, 0xEF,
    TILE_BLACK,

    // Zeile 3 (unten)
    TILE_BLACK, TILE_BLACK, TILE_BLACK, TILE_BLACK, TILE_BLACK,
    TILE_BLACK, TILE_BLACK, TILE_BLACK, TILE_BLACK, TILE_BLACK,
    TILE_BLACK, TILE_BLACK, TILE_BLACK, TILE_BLACK, TILE_BLACK,
    TILE_BLACK, TILE_BLACK, TILE_BLACK,

    // Zeile 4 (Rand/Pfeil)
    TILE_BLACK, TILE_BLACK, TILE_BLACK, TILE_BLACK, TILE_BLACK,
    TILE_BLACK, TILE_BLACK, TILE_BLACK, TILE_BLACK, TILE_BLACK,
    TILE_BLACK, TILE_BLACK, TILE_BLACK, TILE_BLACK, TILE_BLACK,
    TILE_BLACK, TILE_BLACK, TILE_ARROW
};

/* ---------------------------------------------------------
   show_dia_wnd():
   Schreibt 2 Zeilen ab last_lin in den Window-Layer.
   Gibt den neuen Zeilenindex zurück (last_lin + 2 oder Ende).
   --------------------------------------------------------- */
uint8_t show_dia_wnd(const unsigned char text_lines[][DIALOG_MAX_STRING_SIZE],
                     uint8_t amount_lin,
                     uint8_t last_lin) {
    dialog_window_visible = 1;

    // Schwarze Tile & Pfeil in den Win-VRAM
    set_win_data(TILE_BLACK, 1, black_tile);
    set_win_data(TILE_ARROW, 1, arrow_tile);

    // 2 Zeilen = 32 Tiles schwarz füllen
    for (uint8_t i = 0; i < 32; i++) {
        set_win_data(DIALOG_FIRST_ROW_START + i, 1, black_tile);
    }

    // 2 Zeilen Text kopieren
    for (uint8_t row = 0; row < 2; row++) {
        if ((row + last_lin) >= amount_lin) break; // keine Zeile mehr
        for (uint8_t col = 0; col < 16; col++) {
            unsigned char c = text_lines[row + last_lin][col];
            set_win_data(DIALOG_FIRST_ROW_START + (row * 16) + col,
                         1,
                         char_sprites[c - CHAR_OFFSET]);
        }
    }

    // Tilemap ins Window
    set_win_tiles(0, 0, 18, 5, dia_wnd_tilemap);
    move_win(15, 104); // verschiebe Window ein bisschen runter
    SHOW_WIN;

    // Index um 2 Zeilen erhöhen
    uint8_t new_pos = last_lin + 2;
    if (new_pos > amount_lin) {
        new_pos = amount_lin;
    }
    return new_pos;
}

/* ======================================================================== */

void main(void) {
    SHOW_BKG;

    if (_cpu == CGB_TYPE) {
        cpu_fast();
        vsync();
        DISPLAY_OFF;

        // Titelbild
        show_titlescreen();
        DISPLAY_ON;
        while (is_title_shown) {
            UPDATE_KEYS();
            if (KEY_IS_PRESSED(J_START)) {
                cancel_titlescreen();
            }
        }

        // Spieler vorbereiten
        SHOW_SPRITES;
        SPRITES_8x16;
        setup_player();

        // Kamera
        uint16_t init_cam_x = player_x - (160 >> 1);
        uint16_t init_cam_y = player_y - (144 >> 1);
        init_camera(init_cam_x, init_cam_y);

        // --- Hauptloop ---
        while (true) {
            UPDATE_KEYS();
            joypad_current = joypad();

            // 1) Dialog-Eingabe abfragen (A/B)
            if (key_down) {
                waitpadup(); // Verhindert Dauerklick
                key_down = 0;
            }

            switch (joypad_current) {
            case J_A:
                if (dialog_window_visible) {
                    // Fenster ist offen
                    uint8_t total_lines = (sizeof(pangram_a) / DIALOG_MAX_STRING_SIZE);
                    if (current_line_index >= total_lines) {
                        // Alles gezeigt -> Schließen
                        HIDE_WIN;
                        dialog_window_visible = 0;
                        current_line_index = 0;
                    } else {
                        // Weitere 2 Zeilen zeigen
                        current_line_index = show_dia_wnd(
                            pangram_a,
                            total_lines,
                            current_line_index
                        );
                    }
                } else {
                    // Fenster war geschlossen -> Checke Tile vor Spieler
                    uint8_t tile_in_front = get_tile_in_front_of_player();
                    // Falls tile_in_front 0x8F oder 0x90 => Dialog starten
                    if ((tile_in_front == 0x8F) || (tile_in_front == 0x90)) {
                        current_line_index = 0;
                        uint8_t total_lines = (sizeof(pangram_a) / DIALOG_MAX_STRING_SIZE);
                        current_line_index = show_dia_wnd(
                            pangram_a,
                            total_lines,
                            current_line_index
                        );
                    } else {
                        // Andernfalls Attacke / Nichts
                    }
                }
                key_down = 1;
                break;

            case J_B:
                // Schließe Fenster sofort
                if (dialog_window_visible) {
                    HIDE_WIN;
                    dialog_window_visible = 0;
                    current_line_index = 0;
                }
                key_down = 1;
                break;
            }

            // 2) Nur wenn Fenster nicht offen: Spieler bewegen
            if (!dialog_window_visible) {
                update_two_frame_counter();
                uint8_t last_sprite = update_player();
                hide_sprites_range(last_sprite, 40);
            } else {
                // Fenster offen -> Spieler einfrieren?
                hide_sprites_range(0, 40);
            }

            // Sprite-Paletten aktualisieren
            set_sprite_palette(0, palettes_PALETTE_COUNT, palettes_palettes);

            wait_vbl_done();
        }
    }
}
