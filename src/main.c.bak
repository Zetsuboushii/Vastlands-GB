#include <gb/gb.h>
#include <rand.h>
#include <stdlib.h>
#include <stdio.h>
#include <gbdk/console.h>

#define WIDTH 20
#define HEIGHT 16
#define WALL '#'
#define FLOOR '.'
#define PLAYER '&'

char dungeon[HEIGHT][WIDTH];
uint8_t_t player_x = 6;
uint8_t_t player_y = 6;

void generate_dungeon() {
    for (uint8_t_t y = 0; y < HEIGHT; y++) {
        for (uint8_t_t x = 0; x < WIDTH; x++) {
            if (rand() % 3 == 0) {
                dungeon[y][x] = WALL;
            } else {
                dungeon[y][x] = FLOOR;
            }
        }
    }
}

void print_dungeon() {
    for (uint8_t_t y = 0; y < HEIGHT; y++) {
        for (uint8_t_t x = 0; x < WIDTH; x++) {
            gotoxy(x, y);

            printf("%c", dungeon[y][x]);
        }
    }
}

void draw_player() {
    gotoxy(player_x, player_y);
    printf("%c", PLAYER);
}

void move_player(const int8_t dx, const int8_t dy) {
    const uint8_t_t new_x = player_x + dx;
    const uint8_t_t new_y = player_y + dy;

    if (new_x < WIDTH && new_y < HEIGHT && dungeon[new_y][new_x] != WALL) {
        gotoxy(player_x, player_y);
        printf("%c", FLOOR);

        player_x = new_x;
        player_y = new_y;

        draw_player();
    }
}

void main() {
    generate_dungeon();
    print_dungeon();

    draw_player();

    // ReSharper disable once CppDFAEndlessLoop
    while (1) {
        const uint8_t_t joy = joypad();

        if (joy & J_LEFT) {
            move_player(-1, 0);
        } else if (joy & J_RIGHT) {
            move_player(1, 0);
        } else if (joy & J_UP) {
            move_player(0, -1);
        } else if (joy & J_DOWN) {
            move_player(0, 1);
        }

        delay(100);
    }
}
